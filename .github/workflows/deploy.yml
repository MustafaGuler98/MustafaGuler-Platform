name: Deploy to Production (Hetzner)

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_USER: mustafa
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: mustafa_platform
          CONNECTIONSTRING_DEFAULT: Host=db;Port=5432;Database=mustafa_platform;Username=mustafa;Password=${{ secrets.POSTGRES_PASSWORD }}
          ASPNETCORE_ENVIRONMENT: Production
          TOKEN_SECURITYKEY: ${{ secrets.JWT_KEY }}
          TOKEN_ISSUER: mustafaguler.me
          TOKEN_AUDIENCE: mustafaguler.me
          ADMIN_EMAIL: mail.mustafaguler@gmail.com
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          MAILSETTINGS_HOST: smtp.resend.com
          MAILSETTINGS_PORT: 587
          MAILSETTINGS_USER: resend
          MAILSETTINGS_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAILSETTINGS_FROMEMAIL: contact@mustafaguler.me
          MAILSETTINGS_TOEMAIL: contact.mustafaguler@gmail.com
          SEQ_ACCEPT_EULA: Y
          NEXT_PUBLIC_API_URL: /api
          INTERNAL_API_URL: http://api:8080
          NEXT_PUBLIC_BACKEND_URL: https://mustafaguler.me
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,CONNECTIONSTRING_DEFAULT,ASPNETCORE_ENVIRONMENT,TOKEN_SECURITYKEY,TOKEN_ISSUER,TOKEN_AUDIENCE,ADMIN_EMAIL,ADMIN_PASSWORD,MAILSETTINGS_HOST,MAILSETTINGS_PORT,MAILSETTINGS_USER,MAILSETTINGS_PASSWORD,MAILSETTINGS_FROMEMAIL,MAILSETTINGS_TOEMAIL,SEQ_ACCEPT_EULA,NEXT_PUBLIC_API_URL,INTERNAL_API_URL,NEXT_PUBLIC_BACKEND_URL
          script: |
            if [ -d "app" ] && [ ! -d "app/.git" ]; then
              rm -rf app
            fi

            if [ ! -d "app" ]; then
              git clone -b prod https://github.com/MustafaGuler98/MustafaGuler-Platform.git app
            fi

            cd app
            git pull origin prod
            chmod +x ./scripts/backup_db.sh

            echo "POSTGRES_USER=$POSTGRES_USER" > .env
            echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
            echo "POSTGRES_DB=$POSTGRES_DB" >> .env
            echo "CONNECTIONSTRING_DEFAULT=$CONNECTIONSTRING_DEFAULT" >> .env
            echo "ASPNETCORE_ENVIRONMENT=$ASPNETCORE_ENVIRONMENT" >> .env
            echo "TOKEN_SECURITYKEY=$TOKEN_SECURITYKEY" >> .env
            echo "TOKEN_ISSUER=$TOKEN_ISSUER" >> .env
            echo "TOKEN_AUDIENCE=$TOKEN_AUDIENCE" >> .env
            echo "ADMIN_EMAIL=$ADMIN_EMAIL" >> .env
            echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> .env
            echo "MAILSETTINGS_HOST=$MAILSETTINGS_HOST" >> .env
            echo "MAILSETTINGS_PORT=$MAILSETTINGS_PORT" >> .env
            echo "MAILSETTINGS_USER=$MAILSETTINGS_USER" >> .env
            echo "MAILSETTINGS_PASSWORD=$MAILSETTINGS_PASSWORD" >> .env
            echo "MAILSETTINGS_FROMEMAIL=$MAILSETTINGS_FROMEMAIL" >> .env
            echo "MAILSETTINGS_TOEMAIL=$MAILSETTINGS_TOEMAIL" >> .env
            echo "SEQ_ACCEPT_EULA=$SEQ_ACCEPT_EULA" >> .env
            echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> .env
            echo "INTERNAL_API_URL=$INTERNAL_API_URL" >> .env
            echo "NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL" >> .env

            docker compose down || true
            
            docker rm -f mustafa-prod-frontend || true
            docker rm -f mustafa-prod-api || true
            docker rm -f mustafa-prod-nginx || true
            docker rm -f mustafa-seq || true

            sleep 3
            
            docker compose up -d --build


