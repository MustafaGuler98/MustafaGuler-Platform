name: Deploy to Production (Hetzner)

on:
  push:
    branches:
      - spotify

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_USER: mustafa
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: mustafa_platform
          CONNECTIONSTRING_DEFAULT: Host=db;Port=5432;Database=mustafa_platform;Username=mustafa;Password=${{ secrets.POSTGRES_PASSWORD }}
          ASPNETCORE_ENVIRONMENT: Production
          TOKEN_SECURITYKEY: ${{ secrets.JWT_KEY }}
          TOKEN_ISSUER: mustafaguler.me
          TOKEN_AUDIENCE: mustafaguler.me
          ADMIN_EMAIL: mail.mustafaguler@gmail.com
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          MAILSETTINGS_HOST: smtp.resend.com
          MAILSETTINGS_PORT: 587
          MAILSETTINGS_USER: resend
          MAILSETTINGS_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAILSETTINGS_FROMEMAIL: contact@mustafaguler.me
          MAILSETTINGS_TOEMAIL: contact.mustafaguler@gmail.com
          SEQ_ACCEPT_EULA: Y
          LASTFM_APIKEY: ${{ secrets.LASTFM_APIKEY }}
          LASTFM_USERNAME: ${{ secrets.LASTFM_USERNAME }}
          NEXT_PUBLIC_API_URL: /api
          INTERNAL_API_URL: http://api:8080
          NEXT_PUBLIC_BACKEND_URL: https://mustafaguler.me
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,CONNECTIONSTRING_DEFAULT,ASPNETCORE_ENVIRONMENT,TOKEN_SECURITYKEY,TOKEN_ISSUER,TOKEN_AUDIENCE,ADMIN_EMAIL,ADMIN_PASSWORD,MAILSETTINGS_HOST,MAILSETTINGS_PORT,MAILSETTINGS_USER,MAILSETTINGS_PASSWORD,MAILSETTINGS_FROMEMAIL,MAILSETTINGS_TOEMAIL,SEQ_ACCEPT_EULA,NEXT_PUBLIC_API_URL,INTERNAL_API_URL,NEXT_PUBLIC_BACKEND_URL,LASTFM_APIKEY,LASTFM_USERNAME
          script: |
            if [ -d "app" ] && [ ! -d "app/.git" ]; then
              rm -rf app
            fi

            if [ ! -d "app" ]; then
              git clone -b spotify https://github.com/MustafaGuler98/MustafaGuler-Platform.git app
            fi

            cd app
            git fetch --all
            git reset --hard origin/spotify
            
            chmod +x ./scripts/backup_db.sh
            mkdir -p logs
            chmod 700 logs

            rm -f .env
            touch .env
            chmod 600 .env

            printf "POSTGRES_USER='%s'\n" "$POSTGRES_USER" >> .env
            printf "POSTGRES_PASSWORD='%s'\n" "$POSTGRES_PASSWORD" >> .env
            printf "POSTGRES_DB='%s'\n" "$POSTGRES_DB" >> .env
            printf "CONNECTIONSTRING_DEFAULT='%s'\n" "$CONNECTIONSTRING_DEFAULT" >> .env
            printf "ASPNETCORE_ENVIRONMENT='%s'\n" "$ASPNETCORE_ENVIRONMENT" >> .env
            printf "TOKEN_SECURITYKEY='%s'\n" "$TOKEN_SECURITYKEY" >> .env
            printf "TOKEN_ISSUER='%s'\n" "$TOKEN_ISSUER" >> .env
            printf "TOKEN_AUDIENCE='%s'\n" "$TOKEN_AUDIENCE" >> .env
            printf "ADMIN_EMAIL='%s'\n" "$ADMIN_EMAIL" >> .env
            printf "ADMIN_PASSWORD='%s'\n" "$ADMIN_PASSWORD" >> .env
            printf "MAILSETTINGS_HOST='%s'\n" "$MAILSETTINGS_HOST" >> .env
            printf "MAILSETTINGS_PORT='%s'\n" "$MAILSETTINGS_PORT" >> .env
            printf "MAILSETTINGS_USER='%s'\n" "$MAILSETTINGS_USER" >> .env
            printf "MAILSETTINGS_PASSWORD='%s'\n" "$MAILSETTINGS_PASSWORD" >> .env
            printf "MAILSETTINGS_FROMEMAIL='%s'\n" "$MAILSETTINGS_FROMEMAIL" >> .env
            printf "MAILSETTINGS_TOEMAIL='%s'\n" "$MAILSETTINGS_TOEMAIL" >> .env
            printf "SEQ_ACCEPT_EULA='%s'\n" "$SEQ_ACCEPT_EULA" >> .env
            printf "LASTFM_APIKEY='%s'\n" "$LASTFM_APIKEY" >> .env
            printf "LASTFM_USERNAME='%s'\n" "$LASTFM_USERNAME" >> .env
            printf "NEXT_PUBLIC_API_URL='%s'\n" "$NEXT_PUBLIC_API_URL" >> .env
            printf "INTERNAL_API_URL='%s'\n" "$INTERNAL_API_URL" >> .env
            printf "NEXT_PUBLIC_BACKEND_URL='%s'\n" "$NEXT_PUBLIC_BACKEND_URL" >> .env
            
            
            echo "Stopping containers..."
            docker compose down --remove-orphans || true
            
            sleep 3

            echo "Pruning build cache..."
            docker builder prune -f

            echo "Starting build..."
            docker compose up -d --build --force-recreate


